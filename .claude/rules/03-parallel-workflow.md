# Parallel Agent Workflow

This project supports **parallel Claude Code agents**, each working on isolated branches.

> **Note**: This file is optional. Remove it if you're not using multi-agent workflows.

## Skills (Slash Commands)

Skills live in `.claude/skills/` and create slash commands:
- **Auto-invoked** by Claude when contextually relevant
- **Manual-only** when `disable-model-invocation: true` is set

| Command | Purpose | Auto-Invoke? |
|---------|---------|--------------|
| `/prime` | Load project context | Yes |
| `/work` | Analyze issues, launch parallel agents | No |
| `/ps` | Check parallel session status | Yes |
| `/progress` | Generate visual progress report | Yes |
| `/pr-check` | Validate PR readiness | No |
| `/review-pr` | Process PR review comments | No |
| `/session-wrap` | End-of-session documentation | No |

## Workflow Quick Reference

### Single-Agent Workflow
```
/prime -> Work on tasks -> /pr-check -> Create PR -> /session-wrap
```

### Multi-Agent Workflow
```
/work -> Launches N parallel agents in worktrees
         |- Agent 1: worktree + branch + assigned issues
         |- Agent 2: worktree + branch + assigned issues
         '- ...

Monitor with: /ps (check status of all agents)

Each agent: /prime -> Work -> /pr-check -> Create PR -> /session-wrap

Staff Engineer merges last (handles docs, conflicts)
```

| When... | Run... |
|---------|--------|
| Starting a session | `/prime` (auto-loads) |
| Launching parallel agents | `/work` |
| Checking parallel status | `/ps` |
| Before creating a PR | `/pr-check` |
| After PR review comments | `/review-pr` |
| Generating status update | `/progress` |
| Ending a session | `/session-wrap` |

## Git Hooks

Claude Code hooks in `.claude/hooks/` run automatically:

| Hook | Trigger | Purpose |
|------|---------|---------|
| `pre-commit.sh` | Before `git commit` | Validates linting, blocks secrets, **enforces file ownership** |
| `post-commit.sh` | After `git commit` | Runs tests (non-blocking) |
| `pre-pr-lint.sh` | Before `gh pr create` | Full repo linting |

## File Ownership Enforcement

When running in a parallel session, the `AGENT_OWNS` env var is set automatically.
The pre-commit hook checks this and **blocks commits that touch files outside owned paths**.

- `AGENT_OWNS` is a comma-separated list of path prefixes (e.g. `src/api/,tests/api/`)
- Set automatically by `start-parallel-sessions.sh` from the config `owned_paths` array
- To bypass (only if truly needed): `unset AGENT_OWNS` then commit

## Agent Ownership (Multi-Agent)

If using multiple agents, define ownership to prevent conflicts:

| Agent | Branch | Owns |
|-------|--------|------|
| {{AGENT_1}} | `feat/{{agent-1-branch}}` | `{{agent-1-dirs}}/` |
| {{AGENT_2}} | `feat/{{agent-2-branch}}` | `{{agent-2-dirs}}/` |
| Staff Engineer | `feat/docs` | `docs/`, `knowledge/`, `CLAUDE.md` |

## Conflict Avoidance Rules

1. **Only modify files in your owned directories** (enforced by pre-commit hook via `AGENT_OWNS`)
2. **Never touch** files owned by other agents
3. **Shared files** (`pyproject.toml`, `docker-compose.yml`) - designate one agent as owner
4. **If you need something from another agent's domain**, document it in `docs/INTEGRATION_REQUESTS.md`

## Inter-Agent Awareness

Agents can check what other agents are doing:

1. **Read `.claude-agent.md`** in your worktree root — lists all agents, branches, and owned paths (auto-generated by the launcher)
2. **Read `${TMPDIR:-/tmp}/{{PROJECT_NAME}}-agent-status.json`** — machine-readable status written by `/ps`:
   ```json
   {
     "session": "{{PROJECT_NAME}}-parallel",
     "updated_at": "2026-01-15T12:00:00Z",
     "agents": [
       {"pane": 0, "name": "project-backend", "branch": "feat/backend-api", "state": "working", "last_commit": "feat: add endpoint"}
     ]
   }
   ```
   States: `working` (uncommitted changes), `needs_push`, `idle_or_done`

## Worktree Workflow

Parallel agents use git worktrees for branch isolation:

```bash
# Create worktree for a new agent
git worktree add ../{{PROJECT_NAME}}-{{suffix}} -b feat/{{branch-name}}

# List all worktrees
git worktree list

# Remove after merge
git worktree remove ../{{PROJECT_NAME}}-{{suffix}}
```

## Session Tooling

```bash
# Preview what would launch (dry run)
./scripts/start-parallel-sessions.sh --dry-run --config scripts/configs/my-session.json

# Start parallel agents in tmux
./scripts/start-parallel-sessions.sh --config scripts/configs/my-session.json

# Check status of all sessions
./scripts/parallel-session-status.sh  # or /ps command

# Session config template
scripts/parallel-sessions.json

# Generated configs go to scripts/configs/
# Old configs archived to scripts/configs/archive/
```

## Staff Engineer Meta-Agent

When running parallel sessions, include a Staff Engineer agent:

**Responsibilities**:
1. Read previous session lessons and extract actionable insights
2. Update CLAUDE.md, README.md, docs with changes
3. Create ADRs for significant architectural decisions
4. Write session lessons capturing what worked/didn't work
5. Validate configs (lint, format, tests)

**Merge Order**: Always merge last (after all implementation branches)
